<!DOCTYPE html>
<html>
    <title>EVM Bytecode Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/w3.css">
    <link rel="stylesheet" href="/main.css">

    <head>
        <script src="jquery-3.6.1.js"></script>

        <script>

            // this jQuery function runs once the page is loaded
            $(document).ready(function(){
                // show the disassembler page when site is first loaded
                $(".disassembler-items").show();
                $(".debugger-items").hide();
                // hide the debuggers tables
                $("#debugger-items-stack-div").hide();
                $("#debugger-items-memory-div").hide();
                $("#debugger-items-storage-div").hide();
                $("#debugger-items-globalvariables-div").hide();
                // hide the left side bar, new state button popup
                $("#sidebar-plus-popup").hide();
                $("#sidebar-minus-popup").hide();

                // Add all the states to the left nav bar
                $.get({
                    url: 'http://127.0.0.1:12345/api/v1/getAllStates',
                    contentType: 'application/json',
                    success: function(response) {
                        //console.log(response);
                        for(let key in response){
                            var addedState = $("<a>", {text: key,href:"#",class:"btn-state w3-bar-item w3-button"});
                            $("#sidebar-states").append(addedState);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error: ' + error);
                    }
                });
            });


            $(function() {
                // add click event listener to Disassembler button
                $(".btn-disassembler").click(function() {
                    // hide the Debugger items and show the Disassembler items
                    $(".debugger-items").hide();
                    $(".disassembler-items").show();
                });

                // add click event listener to Debugger button
                $(".btn-debugger").click(function() {
                    // hide the Disassembler items and show the Debugger items
                    $(".disassembler-items").hide();
                    $(".debugger-items").show();
                });

                // add a click event listener to the Disassembly tab's Parse Bytecode button
                $("#disassembler-items-bytecode-button").click(function(){
                    // Send an API request to /parseBytecode
                    var bytecode = new Object();
                    bytecode.bytecode = $("#disassembler-items-bytecode-input").val();
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/parseBytecode',
                        contentType: 'application/json',
                        data: JSON.stringify(bytecode),
                        success: function(response) {
                            var instructions = response;
                            // remove the rows from the table
                            // Update the tables for both Disassembly and Debugger Tabs
                            var instructionTable = $("#disassembler-items-instructions-table tbody");
                            var instructionTableDebugger = $("#debugger-items-instructions-table tbody");
                            instructionTable.empty();
                            instructionTableDebugger.empty()
                            $.each(instructions, function(key, value){
                                var row = $("<tr>");
                                $('<td style="width: 20%;word-wrap:break-word;">').text(key).appendTo(row);
                                $('<td style="width: 45%;word-wrap:break-word;">').text(value[0]).appendTo(row);
                                $('<td style="width: 35%;word-wrap:break-word;">').text(value[1]).appendTo(row);
                                row.appendTo(instructionTable);
                                //row.appendTo(instructionTableDebugger);
                                //console.log(key, value[0], value[1]);
                            });
                            $.each(instructions, function(key, value){
                                var row = $("<tr>");
                                $('<td style="width: 20%;word-wrap:break-word;">').text(key).appendTo(row);
                                $('<td style="width: 45%;word-wrap:break-word;">').text(value[0]).appendTo(row);
                                $('<td style="width: 35%;word-wrap:break-word;">').text(value[1]).appendTo(row);
                                //row.appendTo(instructionTable);
                                row.appendTo(instructionTableDebugger);
                                //console.log(key, value[0], value[1]);
                            });

                            // update the contract's bytecode
                            // Get the global variables
                            $.get({
                                url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                                contentType: 'application/json',
                                success: function(response) {
                                    var globalvariables = response;
                                    // modify the bytecode
                                    if(typeof globalvariables !== "undefined"){
                                        globalvariables["bytecode"] = $("#disassembler-items-bytecode-input").val();
                                        // Update the bytecode with the provided bytecode
                                        $.post({
                                            url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                                            contentType: 'application/json',
                                            data: JSON.stringify(globalvariables),
                                            success: function(response) {
                                            },
                                            error: function(xhr, status, error) {
                                                console.error('Error: ' + error);
                                            }
                                        });
                                    };      
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error: ' + error);
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                $("#debugger-items-program-counter-value").on("change paste keyup select", function(){
                    // code to set scroll bar for instruction table
                    // on debugger tab. set it to the program counter
                    
                    var debuggerInstructionTableDiv = $("#debugger-items-instructions-div");
                    var debuggerInstructionTable = $("#debugger-items-instructions-table");

                    var rowIndex = debuggerInstructionTable.find("td:first-child").filter(function() {
                        return $(this).text() === $("#debugger-items-program-counter-value").val();
                        }).closest("tr").index();
                    
                    // set the scroll position to the program counter
                    if (rowIndex !== -1) {
                        debuggerInstructionTableDiv.scrollTop(0);  // scroll to the top of the table
                        $headerHeight = $("#debugger-items-instructions-table th").height();
                        $tableOffset = $("#debugger-items-instructions-table").offset().top;
                        //console.log($headerHeight);
                        //console.log(rowIndex);
                        //console.log(debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top);
                        var $offset = 0;
                        // scroll to the correct row in the table. The -15 shows a bit of the previous instruction
                        $offset = debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top - $tableOffset + $headerHeight - 15;
                        //console.log("offset: " + $offset);
                        debuggerInstructionTableDiv.scrollTop($offset);
                    }

                    // update the program counter on the server
                    var new_program_counter_value = $("#debugger-items-program-counter-value").val();
                    var newProgramCounterObject = new Object();
                    newProgramCounterObject.pc = parseInt(new_program_counter_value);
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/programCounter',
                        contentType: 'application/json',
                        data: JSON.stringify(newProgramCounterObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                // Debugger Stack/Storage/Memory Buttons
                $("#debugger-items-stack-button").click(function(){
                    $("#debugger-items-globalvariables-div").hide();
                    $("#debugger-items-stack-div").show();
                    $("#debugger-items-memory-div").hide();
                    $("#debugger-items-storage-div").hide();
                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/stack',
                        contentType: 'application/json',
                        success: function(response) {
                            //console.log(response);
                            var stack = response["stack"];
                            // remove the rows from the table
                            // Update the globalvariable table
                            var stackTable = $("#debugger-items-stack-table tbody");
                            stackTable.empty();
                            $.each(stack, function(key, value){
                                var row = $("<tr>");
                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                row.appendTo(stackTable);
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });
                // Debugger Stack/Storage/Memory Buttons
                $("#debugger-items-memory-button").click(function(){
                    $("#debugger-items-globalvariables-div").hide();
                    $("#debugger-items-stack-div").hide();
                    $("#debugger-items-memory-div").show();
                    $("#debugger-items-storage-div").hide();

                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/memory',
                        contentType: 'application/json',
                        success: function(response) {
                            //console.log(response);
                            var memory = response["memory"];
                            // remove the rows from the table
                            // Update the globalvariable table
                            var memoryTable = $("#debugger-items-memory-table tbody");
                            memoryTable.empty();
                            $.each(memory, function(key, value){
                                var row = $("<tr>");
                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(key).appendTo(row);
                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                row.appendTo(memoryTable);
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });
                // Debugger Stack/Storage/Memory Buttons
                $("#debugger-items-storage-button").click(function(){
                    $("#debugger-items-globalvariables-div").hide();
                    $("#debugger-items-stack-div").hide();
                    $("#debugger-items-memory-div").hide();
                    $("#debugger-items-storage-div").show();

                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                        contentType: 'application/json',
                        success: function(response) {
                            //console.log(response);
                            var contract_addr = response["contract.address"];
                            var storage = response["storage"][contract_addr];
                            // remove the rows from the table
                            // Update the globalvariable table
                            var storageTable = $("#debugger-items-storage-table tbody");
                            storageTable.empty();
                            $.each(storage, function(key, value){
                                var row = $("<tr>");
                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(key).appendTo(row);
                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                row.appendTo(storageTable);
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });
                // Debugger Stack/Storage/Memory Buttons
                $("#debugger-items-globalvariables-button").click(function(){
                    $("#debugger-items-globalvariables-div").show();
                    $("#debugger-items-stack-div").hide();
                    $("#debugger-items-memory-div").hide();
                    $("#debugger-items-storage-div").hide();
                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                        contentType: 'application/json',
                        success: function(response) {
                            //console.log(response);
                            var globalvariables = response;
                            // remove the rows from the table
                            // Update the globalvariable table
                            var globalvariablesTable = $("#debugger-items-globalvariables-table tbody");
                            globalvariablesTable.empty();
                            $.each(globalvariables, function(key, value){
                                var row = $("<tr>");
                                $('<td style="word-wrap:break-word;">').text(key).appendTo(row);
                                if(typeof value === "object"){
                                    value = JSON.stringify(value);
                                }
                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                row.appendTo(globalvariablesTable);
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                // left side bar, when states are clicked
                $("#sidebar-states").on("click", "a", function(event){
                    var selectedState = $(event.target).text();
                    //console.log(selectedState);
                    var selectedStateObject = new Object();
                    selectedStateObject.stateName = selectedState;
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/currentState',
                        contentType: 'application/json',
                        data: JSON.stringify(selectedStateObject),
                        success: function(response) {
                            updateStateUI();
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                // left side bar, plus button
                $("#sidebar-plus-button").click(function(){
                    $("#sidebar-plus-popup").fadeIn();
                });
                $("#sidebar-plus-popup-submit").click(function(){
                    $("#sidebar-plus-popup").fadeOut();
                    var newStateName = $("#sidebar-plus-popup-value").val();
                    if(newStateName !== ""){
                        var addedState = $("<a>", {text: newStateName,href:"#",class:"btn-state w3-bar-item w3-button"});
                        $("#sidebar-states").append(addedState);
                        var newStateObject = new Object();
                        newStateObject.stateName = newStateName;
                        $.post({
                            url: 'http://127.0.0.1:12345/api/v1/createState',
                            contentType: 'application/json',
                            data: JSON.stringify(newStateObject),
                            success: function(response) {
                                
                            },
                            error: function(xhr, status, error) {
                                console.error('Error: ' + error);
                            }
                        });
                    }
                });
                $("#sidebar-plus-popup-cancel").click(function(){
                    $("#sidebar-plus-popup").fadeOut();
                });
                // left side bar, delete state button
                $("#sidebar-minus-button").click(function(){
                    $("#sidebar-minus-popup").fadeIn();
                });
                $("#sidebar-minus-popup-submit").click(function(){
                    $("#sidebar-minus-popup").fadeOut();
                    var removeStateName = $("#sidebar-minus-popup-value").val();
                    if(removeStateName !== ""){
                        var removeStateObject = new Object();
                        removeStateObject.stateName = removeStateName;
                        $.post({
                            url: 'http://127.0.0.1:12345/api/v1/removeState',
                            contentType: 'application/json',
                            data: JSON.stringify(removeStateObject),
                            success: function(response) {
                                location.reload();
                            },
                            error: function(xhr, status, error) {
                                console.error('Error: ' + error);
                            }
                        });
                    }
                });
                $("#sidebar-minus-popup-cancel").click(function(){
                    $("#sidebar-minus-popup").fadeOut();
                });

                // run button
                $("#debugger-items-button-run").click(function(){
                    // Get the bytecode
                    var bytecode = new Object();
                    bytecode.bytecode = $("#disassembler-items-bytecode-input").val();
                    // parse the bytecode
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/parseBytecode',
                        contentType: 'application/json',
                        data: JSON.stringify(bytecode),
                        success: function(response) {
                            var instructions = response;
                            // run the bytecode
                            $.post({
                                url: 'http://127.0.0.1:12345/api/v1/runBytecode',
                                contentType: 'application/json',
                                data: JSON.stringify(instructions),
                                success: function(response) {
                                    var output = response;
                                    //console.log(output);
                                    // update the output section
                                    $("#debugger-items-output-message-text").text(output["message"]);
                                    $("#debugger-items-output-eventlog-text").text(output["event_log"]);
                                    $("#debugger-items-output-returndata-text").text(output["return_data"]);
                                    // update the rest of the UI
                                    updateStateUI();
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error: ' + error);
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                // save button
                $("#debugger-items-button-save").click(function(){
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/saveAllStates',
                        contentType: 'application/json',
                        data: JSON.stringify({}),
                        success: function(response) {
                            
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                $("#debugger-items-button-clear").click(function(){
                    // clear stack
                    var stackObject = new Object();
                    stackObject.stack = [];
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/stack',
                        contentType: 'application/json',
                        data: JSON.stringify(stackObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    // clear memory
                    var memoryObject = new Object();
                    memoryObject.memory = {};
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/memory',
                        contentType: 'application/json',
                        data: JSON.stringify(memoryObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    // clear storage
                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                        contentType: 'application/json',
                        success: function(response) {
                            //console.log(response);
                            var contract_addr = response["contract.address"];
                            var globalvariables = response;
                            globalvariables["storage"][contract_addr] = {};
                            $.post({
                                url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                                contentType: 'application/json',
                                data: JSON.stringify(globalvariables),
                                success: function(response) {
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error: ' + error);
                                }
                            }); 
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    // set pc to 0
                    var newProgramCounterObject = new Object();
                    newProgramCounterObject.pc = 0;
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/programCounter',
                        contentType: 'application/json',
                        data: JSON.stringify(newProgramCounterObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    var debuggerInstructionTableDiv = $("#debugger-items-instructions-div");
                    var debuggerInstructionTable = $("#debugger-items-instructions-table");

                    var rowIndex = debuggerInstructionTable.find("td:first-child").filter(function() {
                        return $(this).text() === $("#debugger-items-program-counter-value").val();
                        }).closest("tr").index();
                    
                    // set the scroll position to the program counter
                    if (rowIndex !== -1) {
                        debuggerInstructionTableDiv.scrollTop(0);  // scroll to the top of the table
                        $headerHeight = $("#debugger-items-instructions-table th").height();
                        $tableOffset = $("#debugger-items-instructions-table").offset().top;
                        //console.log($headerHeight);
                        //console.log(rowIndex);
                        //console.log(debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top);
                        var $offset = 0;
                        // scroll to the correct row in the table. The -15 shows a bit of the previous instruction
                        $offset = debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top - $tableOffset + $headerHeight - 15;
                        //console.log("offset: " + $offset);
                        debuggerInstructionTableDiv.scrollTop($offset);
                    }
                    // clear the output section
                    $("#debugger-items-output-message-text").text("");
                    $("#debugger-items-output-eventlog-text").text("");
                    $("#debugger-items-output-returndata-text").text("");
                    // update the UI
                    updateStateUI();
                });

                $("#debugger-items-button-clearStackMemory").click(function(){
                    // clear stack
                    var stackObject = new Object();
                    stackObject.stack = [];
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/stack',
                        contentType: 'application/json',
                        data: JSON.stringify(stackObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    // clear memory
                    var memoryObject = new Object();
                    memoryObject.memory = {};
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/memory',
                        contentType: 'application/json',
                        data: JSON.stringify(memoryObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    // set pc to 0
                    var newProgramCounterObject = new Object();
                    newProgramCounterObject.pc = 0;
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/programCounter',
                        contentType: 'application/json',
                        data: JSON.stringify(newProgramCounterObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                    var debuggerInstructionTableDiv = $("#debugger-items-instructions-div");
                    var debuggerInstructionTable = $("#debugger-items-instructions-table");

                    var rowIndex = debuggerInstructionTable.find("td:first-child").filter(function() {
                        return $(this).text() === $("#debugger-items-program-counter-value").val();
                        }).closest("tr").index();
                    
                    // set the scroll position to the program counter
                    if (rowIndex !== -1) {
                        debuggerInstructionTableDiv.scrollTop(0);  // scroll to the top of the table
                        $headerHeight = $("#debugger-items-instructions-table th").height();
                        $tableOffset = $("#debugger-items-instructions-table").offset().top;
                        //console.log($headerHeight);
                        //console.log(rowIndex);
                        //console.log(debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top);
                        var $offset = 0;
                        // scroll to the correct row in the table. The -15 shows a bit of the previous instruction
                        $offset = debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top - $tableOffset + $headerHeight - 15;
                        //console.log("offset: " + $offset);
                        debuggerInstructionTableDiv.scrollTop($offset);
                    }
                    // update the UI
                    updateStateUI();
                });

                // When Breakpoints is changed
                $("#debugger-items-breakpoints-value").on("change paste keyup select", function(){
                    try{
                        var breakpointValue = $("#debugger-items-breakpoints-value").val();
                        breakpointValueJSON = JSON.parse(breakpointValue);
                        var breakpointObject = new Object();
                        breakpointObject.breakpoints = breakpointValueJSON;
                        $.post({
                            url: 'http://127.0.0.1:12345/api/v1/breakpoints',
                            contentType: 'application/json',
                            data: JSON.stringify(breakpointObject),
                            success: function(response) {
                            },
                            error: function(xhr, status, error) {
                                console.error('Error: ' + error);
                            }
                        });
                    } catch (error) {
                        console.log(error);
                    }
                });
                // When Global Variables are changed
                $("#debugger-items-globalvariables-table").on("change paste keyup select", function(){
                    var tableData = {};
                    $("#debugger-items-globalvariables-table tbody tr").each(function(){
                        var rowData = {};
                        var cols = $(this).find("td");
                        var key = $(cols[0]).text();
                        var value = $(cols[1]).text();
                        if(key == "balances" || key == "extcode" || key == "storage"){
                            value = JSON.parse(value);
                        }
                        tableData[key] = value;
                    });
                    var tableJSON = JSON.stringify(tableData);
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                        contentType: 'application/json',
                        data: tableJSON,
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });
                // When Stack is changed
                $("#debugger-items-stack-table").on("change paste keyup select", function(){
                    var tableData = [];
                    $("#debugger-items-stack-table tbody tr").each(function(){
                        var rowData = {};
                        var cols = $(this).find("td");
                        var value = $(cols[0]).text();
                        if(value !== ""){
                            tableData.push(value);
                        }
                    });
                    var stackObject = new Object();
                    stackObject.stack = tableData;
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/stack',
                        contentType: 'application/json',
                        data: JSON.stringify(stackObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });
                // When Memory is changed
                $("#debugger-items-memory-table").on("change paste keyup select", function(){
                    var tableData = {};
                    $("#debugger-items-memory-table tbody tr").each(function(){
                        var rowData = {};
                        var cols = $(this).find("td");
                        var key = $(cols[0]).text();
                        var value = $(cols[1]).text();
                        tableData[key] = value;
                    });
                    var memoryObject = new Object();
                    memoryObject.memory = tableData;
                    $.post({
                        url: 'http://127.0.0.1:12345/api/v1/memory',
                        contentType: 'application/json',
                        data: JSON.stringify(memoryObject),
                        success: function(response) {
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });
                // When Storage is changed
                $("#debugger-items-storage-table").on("change paste keyup select", function(){
                    var tableData = {};
                    $("#debugger-items-storage-table tbody tr").each(function(){
                        var rowData = {};
                        var cols = $(this).find("td");
                        var key = $(cols[0]).text();
                        var value = $(cols[1]).text();
                        tableData[key] = value;
                    });
                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                        contentType: 'application/json',
                        success: function(response) {
                            //console.log(response);
                            var contract_addr = response["contract.address"];
                            var globalvariables = response;
                            globalvariables["storage"][contract_addr] = tableData
                            $.post({
                                url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                                contentType: 'application/json',
                                data: JSON.stringify(globalvariables),
                                success: function(response) {
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error: ' + error);
                                }
                            }); 
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });
                });

                // new stack item
                $("#debugger-items-stack-new-button").click(function(){
                    var stackTable = $("#debugger-items-stack-table tbody");
                    var row = $("<tr>");
                    $('<td contenteditable="true" style="word-wrap:break-word;">').text("").appendTo(row);
                    row.appendTo(stackTable);
                });
                // new memory item
                $("#debugger-items-memory-new-button").click(function(){
                    var memoryTable = $("#debugger-items-memory-table tbody");
                    var row = $("<tr>");
                    $('<td contenteditable="true" style="word-wrap:break-word;">').text("").appendTo(row);
                    $('<td contenteditable="true" style="word-wrap:break-word;">').text("").appendTo(row);
                    row.appendTo(memoryTable);
                });
                // new storage item
                $("#debugger-items-storage-new-button").click(function(){
                    var storageTable = $("#debugger-items-storage-table tbody");
                    var row = $("<tr>");
                    $('<td contenteditable="true" style="word-wrap:break-word;">').text("").appendTo(row);
                    $('<td contenteditable="true" style="word-wrap:break-word;">').text("").appendTo(row);
                    row.appendTo(storageTable);
                });

                function updateStateUI(){
                    // get the bytecode, update disassembler and debugger tabs
                    $.get({
                        url: 'http://127.0.0.1:12345/api/v1/globalVariables',
                        contentType: 'application/json',
                        success: function(response) {
                            var globalvariables = response;
                            var bytecode = globalvariables["bytecode"];
                            $("#disassembler-items-bytecode-input").val(bytecode);
                            // get the program counter
                            $.get({
                                url: 'http://127.0.0.1:12345/api/v1/programCounter',
                                contentType: 'application/json',
                                success: function(response) {
                                    var programCounterResponse = response;
                                    var pc = programCounterResponse["pc"];
                                    $("#debugger-items-program-counter-value").val(pc);
                                    var debuggerInstructionTableDiv = $("#debugger-items-instructions-div");
                                    var debuggerInstructionTable = $("#debugger-items-instructions-table");

                                    var rowIndex = debuggerInstructionTable.find("td:first-child").filter(function() {
                                        return $(this).text() === $("#debugger-items-program-counter-value").val();
                                        }).closest("tr").index();
                                    
                                    // set the scroll position to the program counter
                                    if (rowIndex !== -1) {
                                        debuggerInstructionTableDiv.scrollTop(0);  // scroll to the top of the table
                                        $headerHeight = $("#debugger-items-instructions-table th").height();
                                        $tableOffset = $("#debugger-items-instructions-table").offset().top;
                                        //console.log($headerHeight);
                                        //console.log(rowIndex);
                                        //console.log(debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top);
                                        var $offset = 0;
                                        // scroll to the correct row in the table. The -15 shows a bit of the previous instruction
                                        $offset = debuggerInstructionTable.find("tr:eq(" + rowIndex + ")").offset().top - $tableOffset + $headerHeight - 15;
                                        //console.log("offset: " + $offset);
                                        debuggerInstructionTableDiv.scrollTop($offset);
                                    }
                                    //console.log(pc);
                                    // get the breakpoints
                                    $.get({
                                        url: 'http://127.0.0.1:12345/api/v1/breakpoints',
                                        contentType: 'application/json',
                                        success: function(response) {
                                            var breakpointsResponse = response;
                                            var breakpoints = breakpointsResponse["breakpoints"];
                                            $("#debugger-items-breakpoints-value").val(breakpoints);
                                            // update global variables
                                            var globalvariablesTable = $("#debugger-items-globalvariables-table tbody");
                                            globalvariablesTable.empty();
                                            $.each(globalvariables, function(key, value){
                                                var row = $("<tr>");
                                                $('<td style="word-wrap:break-word;">').text(key).appendTo(row);
                                                if(typeof value === "object"){
                                                    value = JSON.stringify(value);
                                                }
                                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                                row.appendTo(globalvariablesTable);
                                            });
                                            // update stack
                                            $.get({
                                                url: 'http://127.0.0.1:12345/api/v1/stack',
                                                contentType: 'application/json',
                                                success: function(response) {
                                                    //console.log(response);
                                                    var stack = response["stack"];
                                                    // remove the rows from the table
                                                    // Update the globalvariable table
                                                    var stackTable = $("#debugger-items-stack-table tbody");
                                                    stackTable.empty();
                                                    $.each(stack, function(key, value){
                                                        var row = $("<tr>");
                                                        $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                                        row.appendTo(stackTable);
                                                    });
                                                },
                                                error: function(xhr, status, error) {
                                                    console.error('Error: ' + error);
                                                }
                                            });
                                            // update memory
                                            $.get({
                                                url: 'http://127.0.0.1:12345/api/v1/memory',
                                                contentType: 'application/json',
                                                success: function(response) {
                                                    //console.log(response);
                                                    var memory = response["memory"];
                                                    // remove the rows from the table
                                                    // Update the globalvariable table
                                                    var memoryTable = $("#debugger-items-memory-table tbody");
                                                    memoryTable.empty();
                                                    $.each(memory, function(key, value){
                                                        var row = $("<tr>");
                                                        $('<td contenteditable="true" style="word-wrap:break-word;">').text(key).appendTo(row);
                                                        $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                                        row.appendTo(memoryTable);
                                                    });
                                                },
                                                error: function(xhr, status, error) {
                                                    console.error('Error: ' + error);
                                                }
                                            });
                                            // update storage
                                            var contract_addr = response["contract.address"];
                                            var storage = globalvariables["storage"][contract_addr];
                                            // remove the rows from the table
                                            // Update the globalvariable table
                                            var storageTable = $("#debugger-items-storage-table tbody");
                                            storageTable.empty();
                                            $.each(storage, function(key, value){
                                                var row = $("<tr>");
                                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(key).appendTo(row);
                                                $('<td contenteditable="true" style="word-wrap:break-word;">').text(value).appendTo(row);
                                                row.appendTo(storageTable);
                                            });
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('Error: ' + error);
                                        }
                                    });
                                },
                                error: function(xhr, status, error) {
                                    console.error('Error: ' + error);
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error('Error: ' + error);
                        }
                    });


                };

            });

        </script>
    </head>

    <body>
        <div class="topnav w3-bar w3-theme-d5 w3-large">
            <a href="#" class="btn-disassembler w3-bar-item w3-button">Disassembler</a>
            <a href="#" class="btn-debugger w3-bar-item w3-button">Debugger</a>
        </div>
          
        <div class="sidebar w3-sidebar w3-theme w3-large">
            <div id="sidebar-states">
            </div>
            <div id="sidebar-plus-div" class="btn-state">
                <a id="sidebar-plus-button" class="w3-button w3-large w3-circle w3-ripple w3-blue-grey">+</a>
                <div id="sidebar-plus-popup" title="Enter New State Name">
                    <input type="text" id="sidebar-plus-popup-value" class="w3-input" placeholder="contractA" value="contractA">
                    <button id="sidebar-plus-popup-submit" class="w3-button">Submit</button>
                    <button id="sidebar-plus-popup-cancel" class="w3-button">Cancel</button>
                </div>
            </div>
            <div id="sidebar-minus-div" class="btn-state">
                <a id="sidebar-minus-button" class="w3-button w3-large w3-circle w3-ripple w3-red">-</a>
                <div id="sidebar-minus-popup" title="Enter State Name">
                    <input type="text" id="sidebar-minus-popup-value" class="w3-input" placeholder="contractA" value="">
                    <button id="sidebar-minus-popup-submit" class="w3-button">Submit</button>
                    <button id="sidebar-minus-popup-cancel" class="w3-button">Cancel</button>
                </div>
            </div>
        </div>

        <div class="main-content w3-theme-l1">
            <div class="disassembler-items">
                <!-- items to show when Disassembler button is clicked -->
                <!-- Disassembler -> Bytecode section-->
                <div class="disassembler-items-bytecode w3-cell-row">
                    <div id="disassembler-items-bytecode-text" class="w3-container w3-cell w3-cell-middle w3-center w3-large">
                        <b>Bytecode</b>
                    </div>
                    <div class="w3-container w3-cell w3-cell-middle">
                        <input id="disassembler-items-bytecode-input" class="w3-input" type="text" placeholder="60806040526000340361001157600080fd5b610206806100206000396000f3fe60806040526004361061001e5760003560e01c8063a30da70d14610023575b600080fd5b61002b61002d565b005b610035610106565b610070816000019067ffffffffffffffff16908167ffffffffffffffff168152505034815101815261006d816000015163ffffffff16565b50565b61007861007a565b565b600034146100bd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100b490610181565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f19350505050158015610103573d6000803e3d6000fd5b50565b604051806020016040528061011a81525090565b6101226101a1565b565b600082825260208201905092915050565b7f646f6e742073656e642066756e64732100000000000000000000000000000000600082015250565b600061016b601083610124565b915061017682610135565b602082019050919050565b6000602082019050818103600083015261019a8161015e565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052605160045260246000fdfea26469706673582212202984a32427ae50c08b30f852a00a90f1afccf0ee5e5ceeb78f8227cdb1ec28ad64736f6c63430008110033" value="60806040526000340361001157600080fd5b610206806100206000396000f3fe60806040526004361061001e5760003560e01c8063a30da70d14610023575b600080fd5b61002b61002d565b005b610035610106565b610070816000019067ffffffffffffffff16908167ffffffffffffffff168152505034815101815261006d816000015163ffffffff16565b50565b61007861007a565b565b600034146100bd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100b490610181565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f19350505050158015610103573d6000803e3d6000fd5b50565b604051806020016040528061011a81525090565b6101226101a1565b565b600082825260208201905092915050565b7f646f6e742073656e642066756e64732100000000000000000000000000000000600082015250565b600061016b601083610124565b915061017682610135565b602082019050919050565b6000602082019050818103600083015261019a8161015e565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052605160045260246000fdfea26469706673582212202984a32427ae50c08b30f852a00a90f1afccf0ee5e5ceeb78f8227cdb1ec28ad64736f6c63430008110033">
                    </div>
                    <div class="w3-container w3-cell w3-cell-middle">
                        <button id="disassembler-items-bytecode-button" class="w3-btn w3-indigo">Parse Bytecode</button>
                    </div> 
                </div>
                <!-- Disassembler -> Instructions Table-->
                <div class="disassembler-items-instructions w3-cell-row">
                    <div id="disassembler-items-instructions-text" class="w3-container w3-large">
                        <b>Instructions</b>
                    </div>
                    <div id="disassembler-items-instructions-table-div" class="w3-container">
                        <table id="disassembler-items-instructions-table" class="w3-table-all w3-gray w3-centered disassembler-items-instructions-table">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Program Counter</th>
                                    <th style="width: 45%;">Human Readable</th>
                                    <th style="width: 35%;">Hex</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="debugger-items w3-container">
                <!-- items to show when Debugger button is clicked -->
                <!-- Debugger -> Top Row with buttons -->
                <div id="debugger-items-top-button-row" class="w3-container">
                    <div class="w3-container w3-cell">
                        <b>Program Counter</b>
                        <input id="debugger-items-program-counter-value" class="w3-input" type="number" placeholder="0" value="0"></input>
                    </div>
                    <div class="w3-container w3-cell">
                        <b>Breakpoints</b>
                        <input id="debugger-items-breakpoints-value" class="w3-input" type="text" placeholder="[0]" value="[0]"></input>
                    </div>
                    <div class="w3-container w3-cell">
                        <button id="debugger-items-button-run" class="w3-button w3-blue-grey">Run</button>
                    </div>
                    <div class="w3-container w3-cell">
                        <button id="debugger-items-button-save" class="w3-button w3-indigo">Save</button>
                    </div>
                    <div class="w3-container w3-cell">
                        <button id="debugger-items-button-clear" class="w3-button w3-blue-grey">Clear All</button>
                    </div>
                    <div class="w3-container w3-cell">
                        <button id="debugger-items-button-clearStackMemory" class="w3-button w3-blue-grey">Clear Stack/Memory</button>
                    </div>
                </div>

                <!-- Debugger -> Instructions -->
                <div id="debugger-items-instructions-div">
                    <table id="debugger-items-instructions-table" class="w3-table-all w3-gray w3-centered debugger-items-instructions-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Program Counter</th>
                                <th style="width: 45%;">Human Readable</th>
                                <th style="width: 35%;">Hex</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <!-- Debugger -> Output-->
                <div id="debugger-items-output-div">
                    <!-- Debugger -> Output -> Message -->
                    <div id="debugger-items-output-message-div">
                        <b>Message</b>
                        <p id="debugger-items-output-message-text"></p>
                    </div>
                    <!-- Debugger -> Output -> Event Log -->
                    <div id="debugger-items-output-eventlog-div">
                        <b>Event Log</b>
                        <p id="debugger-items-output-eventlog-text"></p>
                    </div>
                    <!-- Debugger -> Output -> Returndata -->
                    <div id="debugger-items-output-returndata-div">
                        <b>Returndata</b>
                        <p id="debugger-items-output-returndata-text"></p>
                    </div>
                </div>

                <!-- Debugger -> Stack/Storage/Memory-->
                <div id="debugger-items-stack-storage-memory-div">
                    <div class="table_label">
                        <button id="debugger-items-globalvariables-button" class="w3-button w3-blue-grey">Global Variables</button>
                        <button id="debugger-items-stack-button" class="w3-button w3-blue-grey">Stack</button>
                        <button id="debugger-items-memory-button" class="w3-button w3-blue-grey">Memory</button>
                        <button id="debugger-items-storage-button" class="w3-button w3-blue-grey">Storage</button>
                    </div>
                    <!-- Debugger -> Global Variables-->
                    <div id="debugger-items-globalvariables-div">
                        <table id="debugger-items-globalvariables-table" class="w3-table-all w3-gray w3-centered">
                            <thead>
                                <tr>
                                    <th style="width: 20%">Name</th>
                                    <th style="width: 80%">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>0000000000000000000000000000000000000000000000000000000000000000</td>
                                    <td>0000000000000000000000000000000000000000000000000000000000000000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Debugger -> Stack-->
                    <div id="debugger-items-stack-div">
                        <table id="debugger-items-stack-table" class="w3-table-all w3-gray w3-centered">
                            <thead>
                                <tr>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                        <button id="debugger-items-stack-new-button" class="w3-button w3-blue-grey">Add Item</button>
                    </div>
                    <!-- Debugger -> Memory-->
                    <div id="debugger-items-memory-div">
                        <table id="debugger-items-memory-table" class="w3-table-all w3-gray w3-centered">
                            <thead>
                                <tr>
                                    <th>Address</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>0000000000000000000000000000000000000000000000000000000000000000</td>
                                    <td>0000000000000000000000000000000000000000000000000000000000000000</td>
                                </tr>
                            </tbody>
                        </table>
                        <button id="debugger-items-memory-new-button" class="w3-button w3-blue-grey">Add Item</button>
                    </div>
                    <!-- Debugger -> Storage-->
                    <div id="debugger-items-storage-div">
                        <table id="debugger-items-storage-table" class="w3-table-all w3-gray w3-centered">
                            <thead>
                                <tr>
                                    <th>Address</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>0000000000000000000000000000000000000000000000000000000000000000</td>
                                    <td>0000000000000000000000000000000000000000000000000000000000000000</td>
                                </tr>
                            </tbody>
                        </table>
                        <button id="debugger-items-storage-new-button" class="w3-button w3-blue-grey">Add Item</button>
                    </div>
                </div>

            </div>
        </div>

    </body>

</html>
